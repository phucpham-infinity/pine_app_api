"use strict";var t=require("express"),e=require("cors"),o=require("helmet"),s=require("morgan"),r=require("dotenv"),n=require("mongoose"),a=require("jsonwebtoken"),u=require("zod"),i=require("bcryptjs"),c=require("lodash"),d=require("path");function p(t){var e=Object.create(null);return t&&Object.keys(t).forEach((function(o){if("default"!==o){var s=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(e,o,s.get?s:{enumerable:!0,get:function(){return t[o]}})}})),e.default=t,Object.freeze(e)}p(r).config();const y=t=>{var e;return null===(e=process.env)||void 0===e?void 0:e[t]},l=t=>new n.Schema({...t,createdAt:{type:Date,default:new Date},updatedAt:{type:Date,default:new Date}}),m=t=>(e,o,s)=>{try{t.parse({body:e.body,query:e.query,params:e.params}),s()}catch(t){return o.status(400).json({status:400,error:t.issues})}},g=(t,e,o)=>{var s;const r=null===(s=t.header("Authorization"))||void 0===s?void 0:s.replace("Bearer ","");if(!r)return e.status(403).json({status:403,error:"A token is required for authentication"});try{const e=a.verify(r,process.env.TOKEN_SECRET||"MICRO_APP");t.user=e}catch(t){return e.status(401).json({status:401,error:"Invalid Token"})}return o()},b=u.z.object({body:u.z.object({phone:u.z.string(),password:u.z.string(),isUseTouchId:u.z.boolean().default(!1),isUseFaceId:u.z.boolean().default(!1)})}),h=u.z.object({body:u.z.object({phone:u.z.string(),isUseTouchId:u.z.boolean().default(!1),isUseFaceId:u.z.boolean().default(!1)})}),f=u.z.object({body:u.z.object({phone:u.z.string(),password:u.z.string()})}),j=l({phone:{type:String,required:!0,unique:!0},isUseFaceId:{type:Boolean,required:!1},isUseTouchId:{type:Boolean,required:!1},password:{type:String,required:!0}});j.method("doc",(function(){return c.omit(this._doc,["password","__v"])})),j.pre("save",(function(t){var e=this;if(!e.isModified("password"))return t();i.genSalt(10,(function(o,s){if(o)return t(o);i.hash(e.password,s,(function(o,s){if(o)return t(o);e.password=s,t()}))}))})),j.method("comparePassword",(function(t,e){i.compare(t,this.password,(function(t,o){if(t)return e(t,!1);e(null,o)}))})),j.method("generateToken",(function(){return a.sign(this.doc(),process.env.MICRO_APP||"MICRO_APP",{expiresIn:"30d"})}));var q=n.model("User",j);const z="/user/register",w="/user/login-with-phone",N="/user/me",v="/user/update-by-phone",I="/user/phone/:phone",S=t.Router();S.route(z).post([m(b),async(t,e)=>{const{phone:o,password:s,isUseFaceId:r=!1,isUseTouchId:n=!1}=t.body,a=new q({password:s,phone:o,isUseFaceId:r,isUseTouchId:n});try{const t=await a.save();return e.status(200).json({status:"ok",data:{...t.doc(),token:t.generateToken()}})}catch(t){return e.status(400).json({status:400,error:t})}}]),S.route(w).post([m(f),async(t,e)=>{const{password:o,phone:s}=(null==t?void 0:t.body)||{};try{const t=await q.findOne({phone:s});if(!t)return e.status(400).json({status:400,error:"User not found!"});t.comparePassword(o,((o,s)=>o?e.status(400).json({status:400,error:o.message}):s?e.status(200).json({status:"ok",data:{...t.doc(),token:t.generateToken()}}):e.status(400).json({status:400,error:"Password not match!"})))}catch(t){return e.status(400).json({status:400,error:t})}}]),S.route(N).get([g,async(t,e)=>{const{user:o}=t,s=await q.aggregate([{$unwind:{path:"$profile.company",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"userprofilerefs",localField:"phone",foreignField:"phone",as:"profile"}},{$lookup:{from:"profiles",localField:"profile.profileId",foreignField:"_id",as:"profile"}},{$unwind:{path:"$profile",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"usercompanyrefs",localField:"phone",foreignField:"phone",as:"company"}},{$lookup:{from:"companies",localField:"company.companyName",foreignField:"companyName",as:"company"}},{$unwind:{path:"$company",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"requestcompanies",localField:"phone",foreignField:"phone",as:"requestCompany"}},{$unwind:{path:"$requestCompany",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"userraterefs",localField:"phone",foreignField:"phone",as:"rate"}},{$unwind:{path:"$rate",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"accounts",localField:"phone",foreignField:"phone",as:"accounts"}},{$unwind:{path:"$profile.rate",preserveNullAndEmptyArrays:!0}},{$match:{phone:o.phone}}]);return s?e.status(200).json({status:"ok",data:c.omit(null==s?void 0:s[0],["password","__v"])}):e.status(400).json({status:400,error:"User not found!"})}]),S.route(I).get([async(t,e)=>{const{phone:o}=t.params||{};try{const t=await q.findOne({phone:o});return t?e.status(200).json({status:"ok",data:null==t?void 0:t.doc()}):e.status(400).json({status:400,error:"User not found!"})}catch(t){return e.status(400).json({status:400,error:t})}}]),S.route(v).post([m(h),async(t,e)=>{const{isUseFaceId:o,isUseTouchId:s,phone:r}=t.body;try{const t=await q.findOneAndUpdate({phone:r},{$set:{isUseFaceId:o,isUseTouchId:s}},{new:!0});return t||e.status(400).json({status:400,error:"User not found!"}),e.status(200).json({status:"ok",data:null==t?void 0:t.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const _=t.Router();_.route("/ping").get(((t,e)=>{e.json({data:"pong",env:y("DB_URL")})}));const k=u.z.object({body:u.z.object({businessActivity:u.z.string(),companyName:u.z.string(),email:u.z.string(),legalType:u.z.string(),numberOfEmployees:u.z.number()})}),D=l({companyName:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},businessActivity:{type:String,required:!0},legalType:{type:String,required:!0},numberOfEmployees:{type:Number,required:!0}});D.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var A=n.model("Company",D);const O=l({phone:{type:String,required:!0,unique:!0},companyName:{type:String,required:!0}});O.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var E=n.model("UserCompanyRef",O);const R="/company",P="/company/join",U=t.Router();U.route(R).post([g,m(k),async(t,e)=>{const{businessActivity:o,companyName:s,email:r,legalType:n,numberOfEmployees:a}=t.body,u=new A({businessActivity:o,companyName:s,email:r,legalType:n,numberOfEmployees:a});try{const t=await u.save();return e.status(200).json({status:"ok",data:t.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),U.route(P).post([g,async(t,e)=>{const{companyName:o}=t.query||{},{phone:s}=t.user||{};try{const t=new E({phone:s,companyName:o}),r=await t.save();return e.status(200).json({status:"ok",data:null==r?void 0:r.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const $=u.z.object({body:u.z.object({firstName:u.z.string(),lastName:u.z.string(),nationality:u.z.string(),IDNumber:u.z.string().optional(),passportNumber:u.z.string().optional(),issueDate:u.z.string().optional(),expiryDate:u.z.string().optional()})}),T=u.z.object({body:u.z.object({firstName:u.z.string().optional(),lastName:u.z.string().optional(),nationality:u.z.string().optional(),IDNumber:u.z.string().optional(),passportNumber:u.z.string().optional(),issueDate:u.z.string().optional(),expiryDate:u.z.string().optional()})}),F=l({firstName:{type:String,required:!0},lastName:{type:String,required:!0},nationality:{type:String,required:!0},IDNumber:{type:String,required:!1},passportNumber:{type:String,required:!1},issueDate:{type:Date,required:!1},expiryDate:{type:Date,required:!1}});F.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var x=n.model("Profile",F);const C=l({phone:{type:String,required:!0,unique:!0},profileId:{type:n.Types.ObjectId,ref:"Profile",unique:!0}});C.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var B=n.model("UserProfileRef",C);const L="/profile",M="/profile",G=t.Router();G.route(L).post([g,m($),async(t,e)=>{const{IDNumber:o,firstName:s,expiryDate:r,issueDate:n,lastName:a,nationality:u,passportNumber:i}=t.body,{phone:c}=(null==t?void 0:t.user)||{};try{const t=new x({IDNumber:o,firstName:s,expiryDate:r,issueDate:n,lastName:a,nationality:u,passportNumber:i}),d=await t.save(),p=new B({phone:c,profileId:d.id});return await p.save(),e.status(200).json({status:"ok",data:d.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),G.route(M).put([g,m(T),async(t,e)=>{const{IDNumber:o,firstName:s,expiryDate:r,issueDate:n,lastName:a,nationality:u,passportNumber:i,id:c}=t.body;try{const t=await x.findByIdAndUpdate(c,{$set:{IDNumber:o,firstName:s,expiryDate:r,issueDate:n,lastName:a,nationality:u,passportNumber:i}},{new:!0});return e.status(200).json({status:"ok",data:null==t?void 0:t.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const V=t.Router();V.route("/analytics/summary").get(((t,e)=>e.json({status:"ok",data:{income:12e3,expenses:8e3,account_balances:[{account_id:"12345",balance:"15000"},{account_id:"67890",balance:"5000"}]}}))),V.route("/analytics/income-expense").get(((t,e)=>e.json({status:"ok",data:{income:[{category:"Sales",amount:1e4,subcategories:[{subcategory:"Product A",amount:6e3},{subcategory:"Product B",amount:4e3}]},{category:"Investments",amount:2e3}],expenses:[{category:"Salaries",amount:5e3},{category:"Rent",amount:3e3},{category:"Utilities",amount:1e3}]}})));const J=u.z.object({body:u.z.object({companyName:u.z.string(),licenseNo:u.z.string(),registerNo:u.z.string(),companyEmail:u.z.string(),userEmail:u.z.string()})});u.z.object({body:u.z.object({companyName:u.z.string().optional(),licenseNo:u.z.string().optional(),registerNo:u.z.string().optional(),companyEmail:u.z.string().optional()})});const K=l({companyName:{type:String,required:!0},licenseNo:{type:String,required:!0},registerNo:{type:String,required:!0},companyEmail:{type:String,required:!0},userEmail:{type:String,required:!0,unique:!0},phone:{type:String,required:!0,unique:!0},status:{type:String,enum:["PENDING","APPROVAL","REJECT"],default:"PENDING"}});K.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var H=n.model("RequestCompany",K);const Q="/request-company",W="/request-company/approval",X="/request-company",Y=t.Router();Y.route(Q).post([g,m(J),async(t,e)=>{const{companyName:o,companyEmail:s,licenseNo:r,registerNo:n,userEmail:a}=t.body,{phone:u}=t.user||{},i=new H({companyName:o,companyEmail:s,licenseNo:r,registerNo:n,userEmail:a,phone:u});try{const t=await i.save();return e.status(200).json({status:"ok",data:t.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),Y.route(W).put([g,async(t,e)=>{const{email:o}=t.query||{};console.log("email",o);try{const t=await H.findOneAndUpdate({userEmail:o},{$set:{status:"APPROVAL"}},{new:!0});return e.status(200).json({status:"ok",data:t})}catch(t){return e.status(400).json({status:400,error:t})}}]),Y.route(X).get([g,async(t,e)=>{const o=c.pick(t.query,["status"]);try{const t=await H.find(o);return e.status(200).json({status:"ok",data:t})}catch(t){return e.status(400).json({status:400,error:t})}}]);const Z=u.z.object({body:u.z.object({name:u.z.string(),fee:u.z.string(),transactions:u.z.string(),atmDeposits:u.z.string(),addOns:u.z.string(),books:u.z.string()})}),tt=u.z.object({body:u.z.object({name:u.z.string().optional(),fee:u.z.string().optional(),transactions:u.z.string().optional(),atmDeposits:u.z.string().optional(),addOns:u.z.string().optional(),books:u.z.string().optional()})}),et=l({name:{type:String,required:!0,unique:!0},fee:{type:String,required:!0},transactions:{type:String,required:!0},atmDeposits:{type:String,required:!0},addOns:{type:String,required:!0},books:{type:String,required:!0},phone:{type:String,required:!0,unique:!0}});et.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var ot=n.model("Rate",et);const st=l({phone:{type:String,required:!0,unique:!0},rateName:{type:String,required:!0}});st.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var rt=n.model("UserRateRef",st);const nt="/rate",at="/rate",ut="/rate",it="/rate/join",ct=t.Router();ct.route(ut).get([g,async(t,e)=>{try{const t=await ot.find();return e.status(200).json({status:"ok",data:t})}catch(t){return e.status(400).json({status:400,error:t})}}]),ct.route(it).post([g,async(t,e)=>{const{rateName:o}=t.query||{},{phone:s}=t.user||{};try{const t=new rt({phone:s,rateName:o}),r=await t.save();return e.status(200).json({status:"ok",data:null==r?void 0:r.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),ct.route(nt).post([g,m(Z),async(t,e)=>{const{name:o,fee:s,transactions:r,atmDeposits:n,addOns:a,books:u}=t.body;try{const t=new ot({name:o,fee:s,transactions:r,atmDeposits:n,addOns:a,books:u}),i=await t.save();return e.status(200).json({status:"ok",data:i.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),ct.route(at).put([g,m(tt),async(t,e)=>{t.body;try{const t=new ot({}),o=await t.save();return e.status(200).json({status:"ok",data:o.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const dt=t.Router();dt.route("/request-delivery").post([(t,e)=>e.status(200).json({status:"ok",data:t.body})]);const pt=u.z.object({body:u.z.object({userId:u.z.string()})});u.z.object({body:u.z.object({userId:u.z.string().optional()})});const yt=l({user:{type:n.Types.ObjectId,ref:"User",required:!0,unique:!0},status:{type:String,enum:["PENDING","APPROVAL","REJECT"],default:"PENDING"}});yt.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var lt=n.model("RequestAccount",yt);const mt="/request-account",gt="/request-account/approval",bt="/request-account",ht=t.Router();ht.route(mt).post([g,m(pt),async(t,e)=>{const{userId:o,status:s}=t.body,r=new lt({status:s,user:o});try{if(!await q.findById(o))return e.status(400).json({status:400,error:"User not found!"});const t=await r.save();return e.status(200).json({status:"ok",data:t.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),ht.route(gt).put([g,async(t,e)=>{const{userId:o}=t.query||{};try{const t=await lt.findOneAndUpdate({user:o},{$set:{status:"APPROVAL"}},{new:!0});return e.status(200).json({status:"ok",data:t})}catch(t){return e.status(400).json({status:400,error:t})}}]),ht.route(bt).get([g,async(t,e)=>{const o=c.pick(t.query,["status"]);try{const t=await lt.find(o);return e.status(200).json({status:"ok",data:t})}catch(t){return e.status(400).json({status:400,error:t})}}]);const ft=u.z.object({body:u.z.object({accountName:u.z.string(),accountNumber:u.z.string(),iban:u.z.string(),swiftCode:u.z.string()})}),jt=l({accountName:{type:String,required:!0,unique:!0},accountNumber:{type:String,required:!0,unique:!0},iban:{type:String,required:!0,unique:!0},swiftCode:{type:String,required:!0},phone:{type:String,required:!0},balance:{type:Number,required:!0,default:0}});jt.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var qt=n.model("Account",jt);const zt=t.Router();zt.route("/account").post([g,m(ft),async(t,e)=>{const{accountName:o,accountNumber:s,iban:r,swiftCode:n}=t.body,{user:a}=t||{};try{const t=new qt({accountName:o,accountNumber:s,iban:r,swiftCode:n,phone:a.phone}),u=await t.save();return e.status(200).json({status:"ok",data:u.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const wt=l({accountId:{type:n.Types.ObjectId,ref:"Account",unique:!0},type:{type:String,required:!0},phone:{type:String,required:!0},amount:{type:Number,required:!0},category:{type:String,required:!0},description:{type:String,required:!0},date:{type:String,required:!0}});wt.method("doc",(function(){return c.omit(this._doc,["password","__v"])}));var Nt=n.model("Transactions",wt);const vt=u.z.object({body:u.z.object({accountId:u.z.string(),type:u.z.string().optional(),amount:u.z.string(),category:u.z.string(),description:u.z.string()})}),It="/transaction",St="/transaction/deposit",_t=t.Router();_t.route(It).post([g,m(vt),async(t,e)=>{const{accountId:o,type:s,amount:r,category:n,description:a}=t.body;try{const t=new Nt({accountId:o,amount:r,category:n,description:a,type:s,date:new Date}),u=await t.save();return e.status(200).json({status:"ok",data:u.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]),_t.route(St).post([g,m(vt),async(t,e)=>{const{accountId:o,amount:s,category:r,description:n}=t.body,{phone:a}=t.user||{};try{const t=await qt.findById(o);if(!t)return e.status(400).json({status:400,error:"Account not found!"});if(!c.isNumber(s))return e.status(400).json({status:400,error:"Amount invalid!"});t.balance=Number(null==t?void 0:t.balance)+Number(s),await t.save();const u=new Nt({accountId:o,amount:s,category:r,description:n,type:"DEPOSIT",date:new Date,phone:a}),i=await u.save();return e.status(200).json({status:"ok",data:i.doc()})}catch(t){return e.status(400).json({status:400,error:t})}}]);const kt=+y("PORT"),Dt=y("DB_URL");kt&&Dt||(console.error("Missing env!"),process.exit(1));const At=t();At.use(s("combined")),At.use(o({contentSecurityPolicy:!1,frameguard:!1,crossOriginEmbedderPolicy:!1,crossOriginOpenerPolicy:!1,crossOriginResourcePolicy:!1})),At.use(e({origin:"*"})),At.use(t.json()),At.use(t.urlencoded({extended:!1})),At.use(t.static(d.join(__dirname+"/public"))),At.use("/api",[_,S,U,G,V,Y,ct,dt,ht,zt,_t]),At.get("*",(async(t,e)=>e.sendFile(d.join(__dirname+"/public/index.html")))),At.listen(kt,(()=>{console.log(`Server started on port ${kt}: http://localhost:${kt}`),(({db:t})=>{const e=()=>{n.connect(t,{dbName:"pina_app"}).then((t=>console.info(`Successfully connected to ${t.connection.name}`))).catch((t=>(console.error("Error connecting to database: ",t),process.exit(1))))};e(),n.connection.on("disconnected",e)})({db:Dt})})).on("error",(t=>{console.log("ERROR: ",t)})),exports.app=At;
